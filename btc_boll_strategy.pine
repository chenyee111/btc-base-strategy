//@version=6
strategy("ğŸ“Š å¼·åŒ–ç‰ˆ BOLL ç­–ç•¥ (å›ºå®šé–‹å€‰ + è£œå€‰ + è³‡é‡‘æ§ç®¡)", overlay=true, default_qty_type=strategy.fixed)

// === åƒæ•¸è¨­å®š === //
boll_length = input.int(20, title="BOLL æœŸé–“")
boll_mult = input.float(2.0, title="BOLL å€æ•¸")
take_profit = input.int(300, title="å›ºå®šåœåˆ©é»æ•¸")
trail_offset = input.int(200, title="è¿½è¹¤æ­¢æé»æ•¸")
position_risk = input.float(0.05, title="æœ€å¤§ç¸½é¢¨éšª (è³‡é‡‘%)")  // 5%
entry_risk = 0.03  // é¦–å€‰é¢¨éšª 3%
add_risk = 0.02     // åŠ ç¢¼é¢¨éšª 2%

// === BOLL è¨ˆç®— === //
basis = ta.sma(close, boll_length)
deviation = boll_mult * ta.stdev(close, boll_length)
upper = basis + deviation
lower = basis - deviation

// === æŒå€‰è¿½è¹¤ === //
var float avg_entry = na
var int entry_count = 0
var float capital = strategy.equity
max_risk_value = position_risk * capital

// === å¤šå–®æ¢ä»¶ === //
long_condition = close < lower
can_add_long = close < avg_entry - 100 and entry_count == 1

// === ç©ºå–®æ¢ä»¶ === //
short_condition = close > upper
can_add_short = close > avg_entry + 100 and entry_count == 1

// === é–‹å€‰é‡‘é¡è¨ˆç®— === //
entry_qty = (entry_risk * capital) / close
add_qty = (add_risk * capital) / close

// === å¤šå–®é€²å ´ === //
if (long_condition and strategy.position_size == 0)
    strategy.entry("Long", strategy.long, qty=entry_qty)
    avg_entry := close
    entry_count := 1
    alert("ğŸ“¢ å¤šå–®é€²å ´ - åƒ¹æ ¼è·Œç ´ä¸‹è»Œ", alert.freq_once_per_bar)

if (can_add_long and strategy.position_size > 0 and entry_count == 1)
    strategy.entry("LongAdd", strategy.long, qty=add_qty)
    avg_entry := (avg_entry * entry_count + close) / (entry_count + 1)
    entry_count := 2
    alert("ğŸ“¢ å¤šå–®åŠ ç¢¼", alert.freq_once_per_bar)

// === ç©ºå–®é€²å ´ === //
if (short_condition and strategy.position_size == 0)
    strategy.entry("Short", strategy.short, qty=entry_qty)
    avg_entry := close
    entry_count := 1
    alert("ğŸ“¢ ç©ºå–®é€²å ´ - åƒ¹æ ¼çªç ´ä¸Šè»Œ", alert.freq_once_per_bar)

if (can_add_short and strategy.position_size < 0 and entry_count == 1)
    strategy.entry("ShortAdd", strategy.short, qty=add_qty)
    avg_entry := (avg_entry * entry_count + close) / (entry_count + 1)
    entry_count := 2
    alert("ğŸ“¢ ç©ºå–®åŠ ç¢¼", alert.freq_once_per_bar)

// === å‡ºå ´æ¢ä»¶ï¼ˆå›ºå®šåœåˆ© + è¿½è¹¤æ­¢æï¼‰ === //
if (strategy.position_size > 0 and close >= avg_entry + take_profit)
    strategy.close("TP Long", qty_percent=100)
    alert("âœ… å¤šå–®å›ºå®šåœåˆ©", alert.freq_once_per_bar)

if (strategy.position_size < 0 and close <= avg_entry - take_profit)
    strategy.close("TP Short", qty_percent=100)
    alert("âœ… ç©ºå–®å›ºå®šåœåˆ©", alert.freq_once_per_bar)

if (strategy.position_size > 0)
    strategy.exit("Exit Long", from_entry="Long", trail_offset=trail_offset, trail_points=trail_offset)

if (strategy.position_size < 0)
    strategy.exit("Exit Short", from_entry="Short", trail_offset=trail_offset, trail_points=trail_offset)

// === ç•«å‡ºé€šé“ === //
plot(basis, color=color.gray, title="BOLL ä¸­è»¸")
plot(upper, color=color.red, title="BOLL ä¸Šè»Œ")
plot(lower, color=color.green, title="BOLL ä¸‹è»Œ")

// === å¹³å€‰å¾Œé‡ç½® === //
if (strategy.position_size == 0)
    avg_entry := na
    entry_count := 0
